---
title: Playground
---

import { Leva, useControls, button } from 'leva'
import { useRef, useEffect } from 'react'
import create from 'cobe'
import { toRgbString } from '../toColor'

export function Page() {
  const canvasRef = useRef()
  const pause = useRef(false)
  const paramsRef = useRef({})
  const rotationRef = useRef(0)
  const dragRef = useRef({ isDragging: false, startX: 0, startY: 0, startPhi: 0, startTheta: 0, wasDrag: false })
  const manualRotationRef = useRef({ phi: 0, theta: 0 })
  paramsRef.current = useControls({
    phi: { value: 0, min: 0, max: Math.PI * 2 },
    theta: { value: 0, min: -Math.PI / 2, max: Math.PI / 2 },
    mapSamples: { value: 16000, min: 500, max: 100000 },
    dotSize: { value: 0.008, min: 0.001, max: 0.05 },
    baseColor: { r: 60, g: 60, b: 60 },
    landColor: { r: 255, g: 255, b: 255 },
    markerColor: { r: 255, g: 255, b: 255 },
    markerSize: { value: 0.05, min: 0, max: 0.1 },
    range: { value: 2000, min: 0, max: 20000 },
    rangeColor: { r: 255, g: 128, b: 0 },
    rangeOpacity: { value: 0.5, min: 0, max: 1 },
    scale: { value: 1, min: 0, max: 4 },
    offsetX: { value: 0, min: -1, max: 1 },
    offsetY: { value: 0, min: -1, max: 1 },
    backgroundColor: { r: 255, g: 255, b: 255, a: 1 },
    'Toggle Rotation': button(() => {
      pause.current = !pause.current
    }),
  })
  const backgroundColor = toRgbString(paramsRef?.current?.backgroundColor)
  useEffect(() => {
    if (!canvasRef.current) return
    const canvas = canvasRef.current
    const size = Math.min(window.innerHeight, window.innerWidth, 800)
    canvas.width = size * 2
    canvas.height = size * 2

    const markerLocations = [
      // San Francisco - default color
      { location: [37.7595, -122.4367] },
      // New York - red
      { location: [40.7128, -74.006], color: [1, 0, 0] },
      // Berlin - green
      { location: [52.520008, 13.404954], color: [0, 1, 0] },
      // London - blue
      { location: [51.507351, -0.127758], color: [0, 0, 1] },
      // Tokyo - yellow
      { location: [35.689487, 139.691711], color: [1, 1, 0] },
      // Hong Kong - cyan
      { location: [22.396427, 114.109497], color: [0, 1, 1] },
      // Cairo - purple
      { location: [30.047503, 31.233702], color: [0.8, 0, 0.8] },
      // Sydney - orange (using default)
      { location: [-33.86882, 151.20929] },
      // Brazil - pink
      { location: [-9.746956, -44.261249], color: [1, 0.4, 0.7] },
    ]
    const globe = create(canvas, {
      devicePixelRatio: 2,
      width: size * 2,
      height: size * 2,
      phi: 0,
      theta: 0,
      mapSamples: paramsRef.current.mapSamples,
      baseColor: [0.3, 0.3, 0.3],
      landColor: [1, 1, 1],
      markerColor: [1, 0.5, 1],
      range: paramsRef.current.range,
      rangeColor: [1, 0.5, 0],
      markers: markerLocations.map((marker) => ({ ...marker, size: paramsRef.current.markerSize })),
      onRender: (state) => {
        state.phi = paramsRef.current.phi + rotationRef.current + manualRotationRef.current.phi
        if (!pause.current && !dragRef.current.isDragging) rotationRef.current += 0.003
        state.theta = paramsRef.current.theta + manualRotationRef.current.theta
        state.mapSamples = paramsRef.current.mapSamples
        state.dotSize = paramsRef.current.dotSize
        state.baseColor = [
          paramsRef.current.baseColor.r / 255,
          paramsRef.current.baseColor.g / 255,
          paramsRef.current.baseColor.b / 255,
        ]
        state.landColor = [
          paramsRef.current.landColor.r / 255,
          paramsRef.current.landColor.g / 255,
          paramsRef.current.landColor.b / 255,
        ]
        state.markerColor = [
          paramsRef.current.markerColor.r / 255,
          paramsRef.current.markerColor.g / 255,
          paramsRef.current.markerColor.b / 255,
        ]
        state.markers = markerLocations.map((marker) => ({ ...marker, size: paramsRef.current.markerSize }))
        state.scale = paramsRef.current.scale
        state.offset = [
          paramsRef.current.offsetX * size * 4,
          paramsRef.current.offsetY * size * 4,
        ]
        state.range = paramsRef.current.range
        state.rangeColor = [
          paramsRef.current.rangeColor.r / 255,
          paramsRef.current.rangeColor.g / 255,
          paramsRef.current.rangeColor.b / 255,
        ]
        state.rangeOpacity = paramsRef.current.rangeOpacity
      },
    })

    // Drag handlers for manual rotation
    const handleMouseDown = (e) => {
      dragRef.current = {
        isDragging: true,
        startX: e.clientX,
        startY: e.clientY,
        startPhi: manualRotationRef.current.phi,
        startTheta: manualRotationRef.current.theta,
        wasDrag: false
      }
    }

    const handleMouseMove = (e) => {
      if (!dragRef.current.isDragging) return
      const dx = e.clientX - dragRef.current.startX
      const dy = e.clientY - dragRef.current.startY
      if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
        dragRef.current.wasDrag = true
      }
      manualRotationRef.current.phi = dragRef.current.startPhi + dx * 0.005
      manualRotationRef.current.theta = Math.max(-Math.PI / 2, Math.min(Math.PI / 2,
        dragRef.current.startTheta + dy * 0.005
      ))
    }

    const handleMouseUp = () => {
      dragRef.current.isDragging = false
    }

    // Prevent click from firing on drag
    const handleClick = (e) => {
      if (dragRef.current.wasDrag) {
        e.stopPropagation()
        dragRef.current.wasDrag = false
      }
    }

    canvas.addEventListener('mousedown', handleMouseDown)
    canvas.addEventListener('click', handleClick, true) // Capture phase to intercept before core handler
    window.addEventListener('mousemove', handleMouseMove)
    window.addEventListener('mouseup', handleMouseUp)

    return () => {
      canvas.removeEventListener('mousedown', handleMouseDown)
      canvas.removeEventListener('click', handleClick, true)
      window.removeEventListener('mousemove', handleMouseMove)
      window.removeEventListener('mouseup', handleMouseUp)
      globe.destroy()
    }
  }, [])
  return (
    <>
      <div style={{ position: 'absolute', right: 20, top: 20, zIndex: 1 }}>
        <Leva fill />
      </div>
      <canvas
        ref={canvasRef}
        style={{
          width: 'min(100vmin, 800px)',
          height: 'min(100vmin, 800px)',
          margin: '20px auto',
          backgroundColor,
          cursor: 'grab'
        }}
      />
    </>
  )
}

<Page />
